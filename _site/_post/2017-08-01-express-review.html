<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <title>Expr.IO by kevinkassimo</title>
        <link rel="stylesheet" href="/assets/css/style.css?v=119c338442b28b5c69c8dc66ab2cf5f8be0737e9">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script src="/assets/js/respond.js"></script>
        <!--[if lt IE 9]>
            <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <!--[if lt IE 8]>
            <link rel="stylesheet" href="/assets/css/ie.css">
        <![endif]-->
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    </head>
    <body>
        <div id="header">
            <nav>
                <li class="fork">
                    <a href="http://github.com/kevinkassimo/kevinkassimo.github.io">View On GitHub</a>
                </li>
            </nav>
        </div>

        <div class="wrapper">
            <section>
                <div class="title">
                    <h1>
                         
                        A Look Into ExpressJS' Source Code
                        
                    </h1>
                    <hr>
                    <h4>
                         
                        <object class="svg" type="image/svg+xml" data="/images/icons/clock.svg">Your browser does not support SVG</object> 2017-08-11
                        
                    </h4>
                    <hr>
                </div>
                <h2 id="introduction">Introduction</h2>
<p>ExpressJS is one of the most used NodeJS framework for web application and routing ever since its release. As noted on its <a href="http://expressjs.com/">official website</a>, it has the reputation of being a “fast, unopinionated, minimalist web framework.” Created by TJ Holowaychuk (who later shifted to the development of <a href="http://koajs.com">Koa.js</a> (which we will be reviewing next to see the difference between it and Express)) and currently maintained by Doug Wilson. The current release is Express 4.15.3. However, we will be focusing on the <a href="https://github.com/expressjs/express/tree/master">master branch on Github</a>.</p>

<h2 id="layout">Layout</h2>
<p>The current layout of the project is given in the following graph:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>- lib
  |
  |-- application.js
  |-- express.js
  |-- request.js
  |-- response.js
  |-- utils.js
  |-- view.js
  |__ router
      |
      |-- index.js
      |-- route.js
      |__ layer.js
</code></pre>
</div>
<p>Our analysis of the source code would start from <code class="highlighter-rouge">router</code> section.</p>

<h2 id="router">Router</h2>
<p>The <code class="highlighter-rouge">router</code> section could in fact be considered a somehow more independent section, as it is even having its <a href="https://github.com/pillarjs/router">own repository</a> outside of the overall ExpressJS project. To start, we would see what is inside each of its components.</p>

<h3 id="layerjs">layer.js</h3>
<p>In this file, the class of <code class="highlighter-rouge">Layer</code> is defined. We can understand a <code class="highlighter-rouge">Layer</code> as a unit of operation. For instance, when we use <code class="highlighter-rouge">app.use(...)</code> or <code class="highlighter-rouge">router.use(...)</code> and provide with multiple middleware functions, we are actually adding multiple layers onto the stack contained inside of each. In the <code class="highlighter-rouge">router</code> case, there is a property <code class="highlighter-rouge">router.stack</code> defined. Notice in the lines defining <code class="highlighter-rouge">proto.use</code> (which is in fact the actual <code class="highlighter-rouge">router.use</code> we are exposed with), we see the following code:</p>
<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">callbacks</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="c1">//...</span>
    <span class="kd">var</span> <span class="nx">layer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Layer</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">sensitive</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">caseSensitive</span><span class="p">,</span>
        <span class="na">strict</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">end</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span> <span class="nx">fn</span><span class="p">);</span>
    <span class="nx">layer</span><span class="p">.</span><span class="nx">route</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">layer</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>
<p>Here, any callbacks supplied to <code class="highlighter-rouge">router.use(...)</code> is simply pushed onto the <code class="highlighter-rouge">stack</code>.</p>

<p><code class="highlighter-rouge">Layer</code> takes in a path, options and an operation function as its component. At first, <code class="highlighter-rouge">path</code> is not stored in <code class="highlighter-rouge">layer.path</code>, but in <code class="highlighter-rouge">layer.regexp</code>. This is due to that Express supports <code class="highlighter-rouge">/login/:user/:id</code> like expression, for simple <code class="highlighter-rouge">:user =&gt; username</code> variable value storing feature. Thus, using <code class="highlighter-rouge">Regexp</code> for grouping and mapping becomes handy. Later, <code class="highlighter-rouge">Layer</code> provides <code class="highlighter-rouge">.match(path)</code> method. By executing <code class="highlighter-rouge">layer.match(path)</code>, we compare the given <code class="highlighter-rouge">path</code> with <code class="highlighter-rouge">this.regexp</code> to see if this layer actually matches the path, and such that it should function only to certain paths. During the process, each <code class="highlighter-rouge">:user</code> like expression is matched and having their value stored in <code class="highlighter-rouge">layer.params['user']</code> for later usage.</p>

<p>Another notable thing seen in <code class="highlighter-rouge">Layer</code> is that each layer could function either for <code class="highlighter-rouge">.handle_error()</code> or <code class="highlighter-rouge">.handle_request()</code>, but not both. If the handler fails or encounters the wrong task (such as asking a <code class="highlighter-rouge">.handle_request()</code> only layer to handle error), it would fallback using the provided <code class="highlighter-rouge">next</code>, which is an argument supplied when calling the one of the two handlers.</p>

<h3 id="routejs">route.js</h3>
<p>TODO: add review on the <code class="highlighter-rouge">router</code> section of ExpressJS</p>

                <hr>
                
                <h3>Comments:</h3>
                <a href="https://github.com/kevinkassimo/kevinkassimo.github.io/issues/2">Link to comments</a>
                
            </section>
        </div>
    </body>
    <style>
        .svg {fill: white}
    </style>
    <script type="text/javascript">
    </script>
</html>


